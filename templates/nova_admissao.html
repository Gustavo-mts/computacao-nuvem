{% extends "base.html" %}

{% block title %}Nova Admissão - Sistema de Abrigos{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3">Registrar Nova Admissão</h1>
    <a href="/admissoes" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-2"></i>Voltar
    </a>
</div>

{% if not acolhidos %}
<div class="alert alert-warning" role="alert">
    <h4 class="alert-heading">
        <i class="fas fa-exclamation-triangle me-2"></i>Nenhuma pessoa disponível
    </h4>
    <p>Não há pessoas acolhidas disponíveis para admissão. Todas as pessoas cadastradas já possuem admissões ativas.</p>
    <hr>
    <div class="d-flex gap-2">
        <a href="/pessoas/nova" class="btn btn-success">
            <i class="fas fa-user-plus me-2"></i>Cadastrar Nova Pessoa
        </a>
        <a href="/admissoes" class="btn btn-outline-secondary">Voltar para Admissões</a>
    </div>
</div>
{% else %}

<div class="card">
    <div class="card-body">
        <form method="post" action="/admissoes/criar">
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Pessoa para Admissão</label>
                        <select class="form-select" name="pessoa_id" required>
                            <option value="">Selecione uma pessoa...</option>
                            {% for acolhido in acolhidos %}
                            <option value="{{ acolhido.id_pessoa }}">
                                {{ acolhido.pessoa.nome }} - {{ acolhido.numero_prontuario }}
                            </option>
                            {% endfor %}
                        </select>
                        <div class="form-text">
                            Apenas pessoas sem admissão ativa são exibidas aqui.
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Abrigo de Destino</label>
                        <select class="form-select" name="abrigo_id" required>
                            <option value="">Selecione um abrigo...</option>
                            {% for abrigo in abrigos %}
                            <option value="{{ abrigo.id_abrigo }}">
                                {{ abrigo.nome }} - {{ abrigo.endereco_cidade }} 
                                ({{ abrigo.vagas_disponiveis }}/{{ abrigo.capacidade_total }} vagas disponíveis)
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Data da Admissão</label>
                        <input type="date" class="form-control" name="data_admissao" value="{{ data_hoje }}" required>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Número da Vaga (opcional)</label>
                        <input type="text" class="form-control" name="numero_vaga" placeholder="Ex: V001, B12, etc.">
                        <div class="form-text">
                            Deixe em branco se não tiver numeração específica.
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="alert alert-info" role="alert">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Informação:</strong> Esta admissão será registrada como ativa. A pessoa será vinculada ao abrigo selecionado.
            </div>
            
            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                <a href="/admissoes" class="btn btn-outline-secondary me-md-2">Cancelar</a>
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-save me-2"></i>Registrar Admissão
                </button>
            </div>
        </form>
    </div>
</div>

<div class="mt-4">
    <div class="card bg-light">
        <div class="card-header">
            <h6 class="mb-0">Ações Rápidas</h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <a href="/pessoas/nova" class="btn btn-outline-primary w-100">
                        <i class="fas fa-user-plus me-2"></i>Cadastrar Nova Pessoa
                    </a>
                </div>
                <div class="col-md-4">
                    <a href="/abrigos/novo" class="btn btn-outline-primary w-100">
                        <i class="fas fa-building me-2"></i>Cadastrar Novo Abrigo
                    </div>
                </div>
                <div class="col-md-4">
                    <a href="/funcionarios/novo" class="btn btn-outline-primary w-100">
                        <i class="fas fa-user-tie me-2"></i>Cadastrar Funcionário
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Validação do formulário
    const form = document.querySelector('form');
    const selectAbrigo = document.querySelector('select[name="abrigo_id"]');
    
    if (form && selectAbrigo) {
        form.addEventListener('submit', function(e) {
            const abrigoSelecionado = selectAbrigo.value;
            const opcaoSelecionada = selectAbrigo.querySelector(`option[value="${abrigoSelecionado}"]`);
            
            if (opcaoSelecionada) {
                const texto = opcaoSelecionada.textContent;
                const match = texto.match(/\((\d+)\/\d+ vagas disponíveis\)/);
                
                if (match && parseInt(match[1]) === 0) {
                    e.preventDefault();
                    alert('Atenção: O abrigo selecionado está com lotação máxima!');
                    return false;
                }
            }
        });
    }
    
    // Debug - Log dos dados do formulário antes do envio
    const formulario = document.querySelector('form');
    if (formulario) {
        formulario.addEventListener('submit', function(e) {
            const formData = new FormData(formulario);
            console.log('Dados sendo enviados:');
            for (let [key, value] of formData.entries()) {
                console.log(`${key}: ${value}`);
            }
        });
    }
});
</script>
{% endblock %}
